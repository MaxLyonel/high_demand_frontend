<nz-content class="access-control-content">
  <!-- Tarjetas de roles -->
  <div class="roles-cards">
    @for(rol of availableRoles; track rol.id) {
      <nz-card
        nzHoverable
        class="role-card"
        [nzActions]="[adminAction]"
        [ngClass]="{ 'selected-role': rol.id === selectedRole?.id }"
        (click)="adminRol(rol)"
      >
        <div class="role-content">
          <div class="role-icon" style="background-color: #f0f7ff;">
            <i
              nz-icon
              nzType="user"
              nzTheme="outline"
              [ngStyle]="{ color: getRoleColor(rol.id) }"
            ></i>
          </div>
          <div class="role-info">
            <p class="role-title">{{ rol.name | uppercase }}</p>
            <span nz-typography nzType="secondary">Rol que gestiona las postulaciones</span>
          </div>
        </div>
        <ng-template #adminAction>
          <button nz-button nzType="link" (click)="adminRol(rol)">ADMINISTRAR</button>
        </ng-template>
      </nz-card>
    }
  </div>

  <!-- Panel de administración de permisos -->
  <nz-card class="permisos-container" [nzBordered]="false">
    <nz-tabset>
      <!-- Pestaña de permisos -->
      <nz-tab nzTitle="Permisos">
        <div class="tab-content">
          <div class="permisos-filters">
            <nz-input-group nzSearch class="search-input" nzSize="default">
              <input type="text" nz-input placeholder="Buscar por descriptor" [(ngModel)]="searchText" />
            </nz-input-group>

            <nz-select nzPlaceHolder="Filtrar por estado" [(ngModel)]="filterStatus" style="width: 150px;">
              <nz-option nzValue="all" nzLabel="Todos"></nz-option>
              <nz-option nzValue="active" nzLabel="Activos"></nz-option>
              <nz-option nzValue="inactive" nzLabel="Inactivos"></nz-option>
            </nz-select>

            <button nz-button nzType="primary" (click)="showCreatePermisoModal()">
              <i nz-icon nzType="plus"></i> Nuevo Permiso
            </button>
          </div>
          <nz-table #permisosTable nzSize="small" [nzData]="filteredPermisos" nzBordered [nzLoading]="loadingTable">
            <thead>
              <tr class="header-row">
                <th class="header-cell" nzWidth="80px">Nro</th>
                <th class="header-cell">Acción</th>
                <th class="header-cell">Subject</th>
                <th class="header-cell">Condiciones</th>
                <th class="header-cell">Descripción</th>
                <th class="header-cell">Estado</th>
                <th class="header-cell" nzWidth="150px">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let permiso of permisosTable.data; let i = index">
                <td>{{ i + 1 }}</td>
                <td>
                  <nz-tag class="action-badge" [nzColor]="getActionColor(permiso.action?.name)">
                    {{ permiso.action?.name }}
                  </nz-tag>
                </td>
                <td>{{ permiso.subject?.name }}</td>
                <td>
                  @if((permiso.conditions?.length ?? 0) > 0) {
                    <span>
                      {{ permiso.conditions | json }}
                    </span>
                  } @else {
                    <nz-tag nzMode="default">Sin condiciones</nz-tag>
                  }
                </td>
                <td>
                  <span>{{ permiso.description }}</span>
                </td>
                <td>
                  <nz-tag [nzColor]="permiso.active ? 'green' : 'red'">
                    {{ permiso.active ? 'Activo' : 'Inactivo' }}
                  </nz-tag>
                </td>
                <td>
                  <button nz-button nzType="link" nzSize="small" (click)="editPermiso(permiso)">
                    <i nz-icon nzType="edit"></i> Editar
                  </button>
                  <nz-divider nzType="vertical"></nz-divider>
                  <button nz-button nzType="link" nzSize="small" nzDanger (click)="togglePermisoStatus(permiso)">
                    {{ permiso.active ? 'Desactivar' : 'Activar' }}
                  </button>
                </td>
              </tr>
            </tbody>
          </nz-table>
        </div>
      </nz-tab>

      <!-- Pestaña de asignación de roles -->
      <!-- <nz-tab nzTitle="Asignación de Roles">
        <div class="tab-content">
          <nz-alert nzType="info" nzMessage="Seleccione un usuario para asignarle roles" nzShowIcon class="mb-3"></nz-alert>

          <div class="permisos-filters">
            <nz-input-group nzSearch class="search-input" nzSize="default">
              <input type="text" nz-input placeholder="Buscar usuario" [(ngModel)]="userSearchText" />
            </nz-input-group>
          </div>

          <nz-list class="users-list" [nzLoading]="loadingUsers">
            <nz-list-item *ngFor="let user of filteredUsers" class="user-item">
              <nz-list-item-meta
                [nzTitle]="user.nombre"
                [nzDescription]="user.email">
              </nz-list-item-meta>

              <div>
                <nz-select
                  nzMode="multiple"
                  nzPlaceHolder="Asignar roles"
                  [(ngModel)]="user.roles"
                  style="width: 300px;"
                  (ngModelChange)="updateUserRoles(user)">
                  <nz-option
                    *ngFor="let role of availableRoles"
                    [nzValue]="role.id"
                    [nzLabel]="role.name">
                  </nz-option>
                </nz-select>
              </div>
            </nz-list-item>
          </nz-list>
        </div>
      </nz-tab> -->
    </nz-tabset>
  </nz-card>
</nz-content>

<!-- Modal para crear/editar permisos -->
<nz-modal
  [(nzVisible)]="isPermissionModalVisible"
  [nzTitle]="isEditingPermission ? 'Editar Permiso' : 'Crear Nuevo Permiso'"
  (nzOnCancel)="closePermissionModal()"
  (nzOnOk)="savePermission()"
  nzOkText="Guardar"
  nzCancelText="Cancelar"
  [nzWidth]="800"
>
  <div *nzModalContent class="permiso-form">
    @if(!isEditingPermission){
    <nz-form-item>
      <nz-switch
        [(ngModel)]="use"
        nzCheckedChildren="Crear" nzUnCheckedChildren="Utilizar uno nuevo">
      </nz-switch>
    </nz-form-item>
    }
    @if(!use) {
      <div class="form-row">
        <nz-form-item>
          <nz-form-label nzFor="permission" nzRequired>Permisos</nz-form-label>
          <nz-form-control>
            <nz-select
              nzPlaceHolder="Seleccione un permiso"
              nzAllowClear
              [(ngModel)]="reusedPermission"
            >
              @for(permission of availablePermissions; track permission.id){
                <nz-option [nzValue]="permission" [nzLabel]="permission.description"></nz-option>
              }
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </div>
    } @else {
      <div class="form-row">
        <nz-form-item>
          <nz-form-label nzFor="description" nzRequired>Descripción</nz-form-label>
          <nz-form-control>
            <input nz-input id="description" [(ngModel)]="currentPermission.description" placeholder="Ingrese descripción" />
          </nz-form-control>
        </nz-form-item>
        <nz-form-item>
          <nz-form-label nzFor="accion" nzRequired>Acción</nz-form-label>
          <nz-form-control>
            <nz-select
              id="accion"
              nzPlaceHolder="Seleccione una acción"
              [compareWith]="compareObjects"
              [(ngModel)]="currentPermission.action"
              nzAllowClear
              nzShowSearch
            >
              @for(action of availableActions; track action.id) {
                <nz-option [nzValue]="action" [nzLabel]="action.name"></nz-option>
              }
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </div>

      <div class="form-row">
        <nz-form-item>
          <nz-form-label nzFor="subject" nzRequired>Subject</nz-form-label>
          <nz-form-control>
            <nz-select
              id="subject"
              nzPlaceHolder="Seleccione un subject"
              [compareWith]="compareObjects"
              [(ngModel)]="currentPermission.subject"
              nzAllowClear
              nzShowSearch
            >
              @for(subject of availableSubjects; track subject.id) {
                <nz-option [nzValue]="subject" [nzLabel]="subject.name"></nz-option>
              }
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </div>

      <div class="form-row">
        <nz-form-item class="vertical-label">
          <nz-form-label>Condiciones (Opcional)</nz-form-label>
          <nz-form-control>
            <div class="conditions-builder">
              <div *ngFor="let condition of currentPermission.conditions; let i = index" class="condition-row">

                <!-- nuevos cambios inicio -->
                 <div nz-row [nzGutter]="7">
                  <!-- Campo -->
                  <nz-col nzSpan="6">
                    <nz-select
                      [(ngModel)]="condition.field"
                      nzPlaceHolder="Campo"
                    >
                      <nz-option
                        *ngFor="let field of availableFields"
                        [nzValue]="field"
                        [nzLabel]="field"
                      ></nz-option>
                    </nz-select>
                  </nz-col>

                  <!-- Operador -->
                  <nz-col nzSpan="3">
                    <nz-select
                      [(ngModel)]="condition.operator"
                      nzPlaceHolder="Operador"
                    >
                      <nz-option
                        *ngFor="let op of availableOperators"
                        [nzValue]="op"
                        [nzLabel]="op"
                      ></nz-option>
                    </nz-select>
                  </nz-col>

                  <!-- Selector de Tipo de Condición -->
                  <nz-col nzSpan="5">
                    <nz-select
                      [(ngModel)]="condition.type"
                      nzPlaceHolder="Tipo de valor"
                    >
                      <nz-option nzValue="text" nzLabel="Texto"></nz-option>
                      <nz-option nzValue="number" nzLabel="Número"></nz-option>
                      <nz-option nzValue="date" nzLabel="Fecha única"></nz-option>
                      <nz-option nzValue="dateRange" nzLabel="Rango de fechas"></nz-option>
                      <nz-option nzValue="list" nzLabel="Lista de valores"></nz-option>
                      <nz-option nzValue="boolean" nzLabel="Verdadero/Falso"></nz-option>
                    </nz-select>
                  </nz-col>

                  <nz-col nzSpan="9">
                    <!-- TEXTO -->
                    <input
                      *ngIf="condition.type === 'text'"
                      nz-input
                      [(ngModel)]="condition.value"
                      placeholder="Ingrese texto"
                      style="width: 100%">

                    <!-- NÚMERO -->
                    <input
                      *ngIf="condition.type === 'number'"
                      nz-input
                      type="number"
                      [(ngModel)]="condition.value"
                      placeholder="Ingrese número"
                      style="width: 100%">

                    <!-- FECHA ÚNICA -->
                    <nz-date-picker
                      *ngIf="condition.type === 'date'"
                      [(ngModel)]="condition.value"
                      [nzShowTime]="true"
                      nzFormat="yyyy-MM-dd HH:mm:ss.SSS"
                      style="width: 100%"
                      placeholder="Seleccione fecha">
                    </nz-date-picker>

                    <!-- RANGO DE FECHAS -->
                    <nz-range-picker
                      *ngIf="condition.type === 'dateRange'"
                      [nzShowTime]="true"
                      [(ngModel)]="condition.value"
                      nzFormat="yyyy-MM-dd HH:mm:ss.SSS"
                      style="width: 100%"
                      placeholder="['Inicio', 'Fin']">
                    </nz-range-picker>

                    <!-- LISTA DE VALORES -->
                    <nz-select
                      [(ngModel)]="condition.value"
                      *ngIf="condition.type === 'list'"
                      nzMode="tags"
                      placeholder="Agregar valores"
                      style="width: 100%"
                      nzPlaceHolder="Valores separados por enter">
                    </nz-select>

                    <!-- BOOLEANO -->
                    <nz-select
                      *ngIf="condition.type === 'boolean'"
                      [(ngModel)]="condition.value"
                      style="width: 100%"
                      placeholder="Seleccione">
                      <nz-option nzValue="true" nzLabel="Verdadero"></nz-option>
                      <nz-option nzValue="false" nzLabel="Falso"></nz-option>
                    </nz-select>

                  </nz-col>

                  <nz-col nzSpan="1">
                    <button nz-button nzDanger nzType="text" (click)="removeCondition(i)">
                      <i nz-icon nzType="delete"></i>
                    </button>
                  </nz-col>

                 </div>

                <!-- <nz-input-group nzCompact>
                  <nz-select [(ngModel)]="condition.field" style="width: 30%" nzPlaceHolder="campo">
                    <nz-option *ngFor="let field of availableFields" [nzValue]="field" [nzLabel]="field"></nz-option>
                  </nz-select>
                  <nz-select [(ngModel)]="condition.operator" style="width: 30%" nzPlaceHolder="Operador">
                    <nz-option *ngFor="let op of availableOperators" [nzValue]="op" [nzLabel]="op"></nz-option>
                  </nz-select>
                  <input nz-input [(ngModel)]="condition.value" style="width: 30%" placeholder="Valor">
                  <button nz-button nzDanger (click)="removeCondition(i)">
                    <i nz-icon nzType="delete"></i>
                  </button>
                </nz-input-group> -->
              </div>
              <button nz-button nzType="dashed" (click)="addCondition()" style="width: 100%; margin-top: 8px;">
                <i nz-icon nzType="plus"></i> Añadir condición
              </button>
            </div>
          </nz-form-control>
        </nz-form-item>
      </div>
    }
    <div class="form-row">
      <nz-form-item>
        <nz-form-label>Estado</nz-form-label>
        <nz-form-control>
          <nz-switch [(ngModel)]="currentPermission.active" nzCheckedChildren="Activo" nzUnCheckedChildren="Inactivo"></nz-switch>
        </nz-form-control>
      </nz-form-item>
    </div>
  </div>
</nz-modal>