<nz-card class="seguimiento-container">
  <div class="seguimiento-header">
    <h5 nz-typography class="section-title">SEGUIMIENTO DE SOLICITUDES</h5>
      @if(canViewAllRequests()){
        <div class="seguimiento-filters">
          <nz-space>
            <nz-select
              *nzSpaceItem
              nzPlaceHolder="Filtrar por estado"
              [ngModel]="filterStatusWorkflow()"
              (ngModelChange)="onWorkflowStatusChange($event)"
              nzAllowClear
            >
              <nz-option nzValue="enviado" nzLabel="Enviado"></nz-option>
              <nz-option nzValue="en revision" nzLabel="En revisón"></nz-option>
            </nz-select>

            <nz-select
              *nzSpaceItem
              nzPlaceHolder="Filtrar por estado"
              [ngModel]="filterEstado()"
              (ngModelChange)="onEstadoChange($event)"
              nzAllowClear
            >
              <nz-option nzValue="REGISTRADO" nzLabel="Registrado"></nz-option>
              <nz-option nzValue="APROBADO" nzLabel="Aprobado"></nz-option>
              <nz-option nzValue="OBSERVADO" nzLabel="Observado"></nz-option>
              <nz-option nzValue="ANULADO" nzLabel="Anulado"></nz-option>
              <nz-option nzValue="RECHAZADO" nzLabel="Rechazado"></nz-option>
            </nz-select>

            <nz-date-picker
              *nzSpaceItem
              nzPlaceHolder="Filtrar por fecha"
              [ngModel]="filterFecha()"
              (ngModelChange)="onFechaChange($event)"
              nzStyle="width: 200px"
            ></nz-date-picker>
          </nz-space>
          <nz-input-group nzSearch [nzSuffix]="suffixIconButton">
            <input
              type="text"
              nz-input
              placeholder="Buscar por unidad educativa o SIE"
              [ngModel]="searchValue()"
              (ngModelChange)="onSearchChange($event)"
            />
          </nz-input-group>
          <ng-template #suffixIconButton>
            <button nz-button nzType="primary" nzSearch><i nz-icon nzType="search"></i></button>
          </ng-template>
        </div>
      }

  </div>

  <nz-tabset>
    <nz-tab nzTitle="Seguimiento Solicitud">
      <nz-table
        #trackingTable
        [nzData]="filteredRegistrations()"
        [nzLoading]="loading"
        [nzPageSize]="pageSize"
        [nzPageIndex]="pageIndex"
        nzOuterBordered
        [nzSize]="'small'"
        nzBordered
        nzShowSizeChanger
        class="custom-table"
        [nzScroll]="{ y: '350px' }"
      >
        <thead>
          <tr class="header-row">
            <th class="header-cell" nzWidth="40px">N°</th>
            <th class="header-cell" nzWidth="100px">Acciones</th>
            <th class="header-cell" nzWidth="200px">Unidad Educativa</th>
            <th class="header-cell" >SIE</th>
            <th class="header-cell" >Responsable</th>
            <th class="header-cell" nzWidth="120px">Estado Flujo</th>
            <th class="header-cell" >Rol</th>
            <th class="header-cell" >Estado Solicitud</th>
            <th class="header-cell" >Última Actualización</th>
            <th class="header-cell" >Observación</th>
          </tr>
        </thead>
        <tbody>
          @for(request of trackingTable.data; track request.id; let i = $index; let first = $first) {
            <tr>
              <td>{{ i + 1}}</td>
              <td>
                <div class="acciones-cell">
                  @if(first && request.workflowState === 'ENVIADO' && request.registrationStatus === 'REGISTRADO') {
                    @if(selectedRole?.role?.id === 9 && canUpdateRequest(request)) {
                      <button
                        nz-button
                        nzType="link"
                        nzSize="small"
                        (click)="seeDetail(request)"
                        nz-tooltip="Ver detalle"
                      >
                        <i nz-icon nzType="edit"></i>
                      </button>
                    }
                    @if(canDownloadRequest(request)) {
                      <button
                        nz-button
                        nzType="link"
                        nzSize="small"
                        (click)="descargarDocumentos(request)"
                        nz-tooltip="Descargar solicitud"
                      >
                        <i nz-icon nzType="download"></i>
                      </button>
                    }
                    @if(canAnnularRequest(request)) {
                      <button
                        nz-button
                        nzType="link"
                        nzSize="small"
                        nzDanger
                        (click)="cancelRequest(request)"
                        nz-tooltip="Cancelar solicitud"
                      >
                        <i nz-icon nzType="close-circle"></i>
                      </button>
                    }
                  }
                </div>
              </td>
              <td>{{ request.educationalInstitutionName }}</td>
              <td>{{ request.educationalInstitutionId }}</td>
              <td>{{ request.userName }}</td>
              <td>
                <nz-tag
                  [nzColor]="request.workflowState === 'ENVIADO' ? 'success' : 'warning'"
                >
                  {{ request.workflowState }}
                </nz-tag>
              </td>
              <td>{{ request.rol }}</td>
              <td>
                <nz-tag [nzColor]="request.registrationStatus === RegistrationStatus.APPROVED ? 'success' :
                  (request.registrationStatus === RegistrationStatus.REJECTED || request.registrationStatus === RegistrationStatus.CANCELED) ? 'error' :
                  request.registrationStatus === RegistrationStatus.OBSERVED ? 'warning' : 'processing'"
                >
                  {{ request.registrationStatus }}
                </nz-tag>
              </td>
              <td>{{ request.updatedAt | date:'dd/MM/yyyy HH:mm' }}</td>
              <td>{{ request.observation || 'Sin observación' }}</td>
            </tr>
          }
        </tbody>
      </nz-table>
    </nz-tab>

    @if(!canViewAllRequests()) {
      <nz-tab nzTitle="Historial">
        <div class="historial-scroll">
          <nz-timeline>
            <nz-timeline-item *ngFor="let evento of historial">
              <p>Realizado en: {{ evento.updatedAt | date:'dd/MM/yyyy HH:mm' }}</p>
              <p style="margin-bottom: 5px;">Estado del flujo: <nz-tag nzColor="success"> {{ evento.registrationStatus }}</nz-tag></p>
              <p style="margin-bottom: 5px;">Estado de la postulación: <nz-tag>{{ evento.workflowState }} por: {{ evento.userName }}</nz-tag></p>
              <p class="comentario">
                <i nz-icon nzType="message" nzTheme="fill"></i> {{ evento.observation  || 'Sin observación'}}
              </p>
            </nz-timeline-item>
          </nz-timeline>
        </div>
      </nz-tab>
    }
  </nz-tabset>

  <!-- Modal de detalle -->
  <nz-modal
    [(nzVisible)]="isVisibleModal"
    [nzTitle]="nzModalTitle"
    (nzOnCancel)="handleCancel()"
    (nzOnOk)="handleOk()"
    [nzFooter]="modalFooter"
    [nzWidth]="1300"
  >
    <ng-template #nzModalTitle>
      <b style="color: #045e56">Detalle de Solicitud</b>
    </ng-template>
    <ng-container *nzModalContent>
      <nz-descriptions nzBordered [nzColumn]="2">
        <nz-descriptions-item [nzTitle]="nombreTpl">{{ solicitudSeleccionada?.educationalInstitutionName }}</nz-descriptions-item>
        <nz-descriptions-item [nzTitle]="sieTpl">{{ solicitudSeleccionada?.educationalInstitutionId }}</nz-descriptions-item>
        <nz-descriptions-item [nzTitle]="dateRequestTpl">{{ solicitudSeleccionada?.createdAt | date:'dd/MM/yyyy' }}</nz-descriptions-item>
        <nz-descriptions-item [nzTitle]="statusTpl">
          <nz-tag [nzColor]="getColorEstado(solicitudSeleccionada?.registrationStatus)">{{ solicitudSeleccionada?.registrationStatus }}</nz-tag>
        </nz-descriptions-item>
        <nz-descriptions-item [nzTitle]="resTpl">{{ solicitudSeleccionada?.userName }}</nz-descriptions-item>
        <nz-descriptions-item [nzTitle]="updatedTpl">{{ solicitudSeleccionada?.updatedAt | date:'dd/MM/yyyy HH:mm' }}</nz-descriptions-item>
      </nz-descriptions>

      <ng-template #nombreTpl> <b>Unidad Educativa</b> </ng-template>
      <ng-template #sieTpl> <b>SIE</b> </ng-template>
      <ng-template #dateRequestTpl> <b>Fecha Solicitud</b> </ng-template>
      <ng-template #statusTpl> <b>Estado</b> </ng-template>
      <ng-template #resTpl> <b>Responsable</b> </ng-template>
      <ng-template #updatedTpl> <b>Última Actualización</b> </ng-template>

      <nz-divider [nzText]="coursesTpl"></nz-divider>

      <ng-template #coursesTpl>
        <b>Sección de cursos</b>
      </ng-template>

      <nz-card class="inscription-card">
        <div nz-row [nzGutter]="15">
          <div nz-col [nzSpan]="16">
            <h5 nz-typography class="section-title">INSCRIPCIÓN DE LA UNIDAD EDUCATIVA</h5>

            <div nz-row [nzGutter]="16" nzJustify="start">
              <div nz-col [nzSpan]="9" class="course border-partial-init">
                <div style="padding: 5px;">
                  <span nz-typography ><strong>NIVEL</strong></span>
                  <nz-radio-group
                    nzButtonStyle="solid"
                    class="full-width-radio-group"
                    [(ngModel)]="selectedLevelId"
                    (ngModelChange)="onLevelSelected($event)"
                  >
                    @for(level of levels; track level) {
                      <label nz-radio-button [nzValue]="level.id">{{level.name}}</label>
                    }
                  </nz-radio-group>
                </div>
              </div>
              <div nz-col [nzSpan]="5" class="course">
                <div style="padding: 5px;">
                  <span nz-typography><strong>AÑO ESCOLARIDAD</strong></span>
                  <nz-radio-group
                    nzButtonStyle="solid"
                    class="full-width-radio-group"
                    [(ngModel)]="selectedGradeId"
                    (ngModelChange)="onGradeSelected($event)"
                  >
                    @for(grade of gradesToShow; track grade) {
                      <label nz-radio-button [nzValue]="grade.id">{{grade.name}}</label>
                    }
                  </nz-radio-group>
                </div>
              </div>
              <div nz-col [nzSpan]="5" class="course border-partial-end">
                <div style="padding: 5px;">
                  <span nz-typography><strong>PARALELO</strong></span>
                  <nz-radio-group
                    nzButtonStyle="solid"
                    [(ngModel)]="selectedParallelId"
                  >
                    @for(parallel of parallelsToShow; track parallel) {
                      <label nz-radio-button [nzValue]="parallel.id">Paralelo {{parallel.name}}</label>
                    }
                  </nz-radio-group>
                </div>
              </div>
              <div nz-col [nzSpan]="5">
                <div class="parallel-form">
                  <label class="form-label">Número de plazas</label>
                  <nz-input-group [nzSuffix]="inputClearTpl" class="quota-input">
                    <input
                      type="number"
                      nz-input
                      placeholder="Nro plaza"
                      [(ngModel)]="inputValue"
                    />
                  </nz-input-group>

                  <ng-template #inputClearTpl>
                    <nz-icon
                      class="ant-input-clear-icon"
                      nzTheme="fill"
                      nzType="close-circle"
                      *ngIf="inputValue"
                      (click)="inputValue = null"
                    ></nz-icon>
                  </ng-template>

                  <button
                    nz-button
                    nzType="primary"
                    class="register-btn"
                    [disabled]="disabledButtonRegisterCourse()"
                    (click)="showConfirmRegistrationQuota()"
                  >
                    REGISTRAR
                  </button>
                </div>
              </div>
            </div>
          </div>
          <!-- Sección de cursos seleccionados -->
          <div nz-col [nzSpan]="8">
            <h5 nz-typography class="section-title">AÑOS DE ESCOLARIDAD REGISTRADOS</h5>
            <nz-list
              class="course-list"
              [nzLoading]="initLoading"
              nzItemLayout="horizontal"
              [nzDataSource]="listCourse"
              [nzRenderItem]="item"
            >
              <ng-template #item let-item let-i="index">
                <nz-list-item class="course-item">
                  <div class="course-content">
                    <nz-list-item-meta [nzDescription]="item.name"></nz-list-item-meta>
                    <button
                      nz-button
                      nzDanger
                      nzType="primary"
                      nzShape="circle"
                      nzSize="small"
                      (click)="deleteSelection(i)"
                      [disabled]="selectedCourses().length === 0"
                    >
                      <nz-icon nzType="delete"></nz-icon>
                    </button>
                  </div>
                </nz-list-item>
              </ng-template>
              <ng-template #nzEmpty>
                <div class="empty-list-message" style="text-align: center; padding: 20px;">
                  No hay cursos agregados aún
                </div>
              </ng-template>
            </nz-list>
              <div class="action-buttons">
                <button
                  nz-button
                  nzType="primary"
                  class="mr-2"
                  (click)="showConfirmRegistrationHighDemand()"
                  class="flex-button"
                  [disabled]="
                    !canUpdatePostulation() ||
                    selectedCourses().length === 0"
                >
                  <i nz-icon nzType="check-circle"></i> CONSOLIDAR
                </button>
              </div>
          </div>
        </div>
      </nz-card>

    </ng-container>

    <ng-template #modalFooter>
      <button nz-button nzType="default" (click)="handleCancel()">Cerrar</button>
      <button nz-button nzType="primary" (click)="handleOk()">Aceptar</button>
    </ng-template>
  </nz-modal>
</nz-card>